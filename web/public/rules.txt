rules_version = '2';
service cloud.firestore {
match /databases/{database}/documents {
// Helper functions
function isSignedIn() {
  return request.auth != null;
}

function isOwner(userId) {
  return request.auth.uid == userId;
}

// Users collection
match /users/{userId} {
  allow read: if isSignedIn();
  allow create: if isSignedIn() && isOwner(userId);
  allow update: if isSignedIn() && isOwner(userId);
  allow delete: if false; // Users cannot delete their own account via Firestore
}

// Plant logs collection
match /plantLogs/{logId} {
  allow read: if isSignedIn();
  allow create: if isSignedIn() && 
                  request.resource.data.userId == request.auth.uid &&
                  request.resource.data.keys().hasAll(['userId', 'plantId', 'plantName', 'loggedAt', 'weekId']);
  allow update: if false; // Logs are immutable
  allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
}

// Weekly summaries collection
match /weeklySummaries/{summaryId} {
  allow read: if isSignedIn();
  allow create, update: if isSignedIn() && 
                          request.resource.data.userId == request.auth.uid;
  allow delete: if false; // Summaries should not be deleted
}

// All-time stats collection
match /allTimeStats/{userId} {
  allow read: if isSignedIn();
  allow create, update: if isSignedIn() && isOwner(userId);
  allow delete: if false;
}
}
}